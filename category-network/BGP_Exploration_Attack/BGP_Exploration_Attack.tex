%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Copyright by Wenliang Du.                                       %%
%%  This work is licensed under the Creative Commons                %%
%%  Attribution-NonCommercial-ShareAlike 4.0 International License. %%
%%  To view a copy of this license, visit                           %%
%%  http://creativecommons.org/licenses/by-nc-sa/4.0/.              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\commonfolder}{../../common-files}

\input{\commonfolder/header}
\input{\commonfolder/copyright}


\lhead{\bfseries SEED Labs -- BGP Exploration and Attack}
\newcommand{\bgpFigs}{./Figs}

\begin{document}


\begin{center}
{\LARGE BGP Exploration and Attack Lab}

  \vspace{0.1in}
  {\LARGE (Work in Progress)}
\end{center}

\seedlabcopyright{2021}

\tableofcontents




% *******************************************
% SECTION
% ******************************************* 
\section{Overview}

Border Gateway Protocol (BGP) is the standard exterior gateway protocol
designed to exchange routing and reachability information among autonomous
systems (AS) on the Internet. It is the ``glue'' of the Internet,
and is an essential piece of the Internet infrastructure. It is 
also a primary attack target, because if attackers can 
compromise BGP, they can disconnect the Internet and redirect traffics. 

The goal of this lab is to help students understand how
BGP ``glues'' the Internet together, and how the Internet is actually
connected. We have built an Internet emulator, and will 
use this emulator as the basis for the lab activities. Due to the 
complexity of BGP, a significant portion of this lab description 
is devoted to explaining how BGP works. They are 
essential for the lab activities. 
This lab covers the following topics:
\begin{itemize}[noitemsep]
\item How the BGP protocol works
\item Autonomous systems
\item BGP configuration, BGP Large Communities 
\item Routing 
\item Internet Exchange (IX)
\item BGP attack
\end{itemize}


\paragraph{Videos.}
Detailed coverage of the BGP protocol can be found in 
Section 10 of the SEED Lecture at Udemy, \seedisvideo 
The lecture was recorded before this lab was developed; 
it focuses mostly on the theory part, i.e., explaining how the BGP protocol works. 
This lab provides the practical part.  


\paragraph{Lab environment.} 
\seedenvironmentB
\nodependency


\paragraph{Acknowledgment.} 
This lab was developed with the help of Honghao Zeng, a graduate student
in the Department of Electrical Engineering and Computer Science at Syracuse University.
The SEED project is funded by the US National Science Foundation. 


% *******************************************
% SECTION
% *******************************************
\section{The Lab Setup and the SEED Internet Emulator} 

This lab will be performed inside the SEED Internet Emulator. We will
provide a pre-built emulator in two different forms: (1) Python code,
and (2) container files. The container files are generated from
the Python code. However, students need to install the SEED Emulator source 
code from the GitHub to run the Python code. The container files
can be directly used without the Emulator source code. 

Instructors who would like to customize the emulator can modify the Python
code, generate their own container files, and then provide these
container files to students, replacing the ones included in the 
setup file. 



% *******************************************
% SECTION
% *******************************************
\section{Understanding the Configuration in BIRD} 

The routing software used in this lab is called BIRD, which is 
an acronym standing for ``BIRD Internet Routing Daemon''~\cite{bird}.
It is open source under the GNU General Public License. It 
supports a number of standard routing protocols, including 
the Border Gateway Protocol (BGP),
the Routing Information Protocol (RIP),
and the Open Shortest Path First protocol (OSPF). We will
mainly use BGP and OSPF in this lab. 


BIRD takes the configuration
file \texttt{bird.conf} from the \texttt{/etc/bird/} folder.
In this lab, students need to understand the entries in the 
configuration file. Students also need to make changes
to the file for some tasks. In this section, we provide 
a tutorial to help students understand the 
configuration file. It should be noted that the actual configuration
for BIRD is quite complicated, and most configuration entries 
are protocol specific. Full details of the configuration 
can be found in the BIRD manual~\cite{birdmanual}.


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The Architecture and Routing Tables} 

BIRD has has several routing tables in memory. It uses
the term ``protocol'' to specify how 
to connect a routing table with another entity. Exactly
what entity is connected to depends on the type of the protocol.
If the protocol is a routing protocol, 
such as BGP, OSPF, or RIP, the entity will be an external router.
Namely, the routes received from the external router
are imported to the routing table, while 
the routes stored in the routing table are exported 
to the external router.

Some protocols used in BIRD are not real protocols; 
BIRD simply uses the keyword \texttt{protocol} to specify where
a BIRD routing table gets its routes from, and where the routes
in the table need to be sent to. It also uses \texttt{protocol} 
to connect two routing tables. 

\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.4\textwidth]{Figs/bird-table.pdf}
  \end{center}
  \caption{Relationships among the tables in BIRD}
  \label{bgp:fig:bird-table}
\end{figure}
 
In our setup, we save the routes from the BGP protocol 
into the table \texttt{t\_bgp}, and save
the routes from the OSPF protocol into the table \texttt{t\_ospf}. 
Through \texttt{pipe} protocols, routes in these tables
will flow to BIRD's master table (\texttt{master4} for IPv4).
Through the \texttt{device} protocol, the routes
in the \texttt{master4} table will eventually get 
into the kernel routing table, which is the acutually
routing table used by the operating system for packet forwarding.
Figure~\ref{bgp:fig:bird-table} depicts 
the relationships of these tables. We will explain 
them in further details in the rest of this section. 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The \texttt{device}, \texttt{direct}, and \texttt{kernel} Protocols} 

BIRD has a few special types of ``protocol'', which are not
real protocols, however, they do generate route information,
except that the generation is not through a protocol. 
The followings
are the two important ``fake'' protocols:

\paragraph{The device protocol}. This is not a real routing protocol. It doesn't
generate any route, nor does it accept any route. It is only used to get
information about the network interfaces from the kernel. Without the
\texttt{device protocol}, BIRD will know nothing about the network
interfaces; it will not even be able to run BGP, as it does not know how
to reach BGP peer's IP address. Therefore, this block is mandatory.

\begin{lstlisting}
protocol device {   }
\end{lstlisting}


\paragraph{The direct protocol.} 
This is for generating routes for the directly
connected networks from a list of interfaces. In the \texttt{direct protocol}
block, the \textit{interface} keyword is used to generate routes from an
interface. Assuming that a BGP router uses \texttt{eth0} and \texttt{eth1}
to connect to the autonomous system's internal networks 
\texttt{10.150.0.0/24} and \texttt{10.150.1.0/24}, respectively, 
the \texttt{direct protocol} block in the following 
will generate routing entries for 
\texttt{10.150.0.0/24} and \texttt{10.150.1.0/24}. These routes 
will be stored in the \texttt{t\_direct} table. Later we will 
see that through a pipe, the routes in this table can get 
into the BGP table, and will thus be used by the BGP protocol. 

\begin{lstlisting}
protocol direct local_nets {
    ipv4 {
        table t_direct;
        import all;
    };

    interface "eth0";
    interface "eth1";
}
\end{lstlisting}


\paragraph{The \texttt{kernel} Protocol.} 
This is not a real routing protocol either.
Instead of communicating with other routers in the network, it connects
BIRD's routing table to kernel's routing table. It is the kernel's routing table
that is used in the actual routing, not BIRD's routing table.
This protocol is used to set the kernel routing table using the routes
received from BGP peers. Here
\texttt{import none} means BIRD's routing table will not import anything from
the kernel's routing table; \texttt{export all} means BIRD's routing table
will export all the routes to the kernel's routing table. This is how BGP
routers set the routing table using the data collected from the BGP
protocol.

\begin{lstlisting}
protocol kernel {
    import none;
    export all;
}
\end{lstlisting}



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The BGP Protocol} 

The most important protocol relevant to this lab is the BGP protocol.
This is a real protocol. For each BGP peering, an instance of 
such a protocol needs to be specified in the BIRD configuration 
file. The protocol connects a routing table with another 
BGP router, i.e., it imports/exports rules from/to 
the peer specified in the protocol.
See the following example. 

\begin{lstlisting}
protocol bgp xyz {
    local    10.104.0.3   as 3;
    neighbor 10.104.0.104 as 104;     (*@\pointleft{BGP peer}@*)
    ipv4 {
        table t_bgp;
        import all;        (*@\pointleft{all the routes from peer will be imported}@*)
        export filter {    (*@\pointleft{export selected routes to peer}@*)
           if proto = "static" then reject;
           accept;
        };
    };
}
\end{lstlisting}

The \texttt{local} option in the BGP protocol sets the local IP address and ASN of the BGP session.
The syntax is \texttt{"local [ip\_address] as <asn>"}. The \texttt{[ip\_address]} part is optional,
but it makes the configuration looks clearer and can prevent selecting the wrong IP address for the
BGP session when there are multiple IP addresses on the router. This
IP address should be the one on the IX's network.

The \texttt{neighbor} option in the BGP protocol sets the neighbor IP address and ASN of the BGP
session. This is the actual peering part. In this example, we set up a BGP session
between \texttt{AS3} and \texttt{AS104}, so they can exchange route information using the BGP protocol.
Similarly, the IP address here should be the one on the IX's network.


\paragraph{Channel and table.}
Each protocol is connected to a routing table through a channel. 
BGP supports both IPv4 and IPv6 channels. 
Each channel has two filters, export and import filters, 
which can accept, reject and modify the routes. 
The export filter applies to the routes going from the routing table to the protocol, 
while the import filter applies to the routes coming into the routing table. 

In the example above, the routing table in the IPv4 channel is 
specified (\texttt{t\_bgp}). If no table is specified, the 
default table used is \texttt{master4} (for IPv6, it is \texttt{master6}). The 
\texttt{master4} table is BIRD's master routing table for IPv4 routes. It should 
be noted that this table is not the operating system's routing table, i.e.,
it is not the one used for the actual routing. The one used for the actual
routing is called the kernel routing table. The \texttt{kernel} protocol
described earlier specifies how the routes in  BIRD's master routing
table are exported to the kernel routing table. 

\paragraph{Filter.}
When importing/exporting routes to/from the routing table, 
filter rules can be applied. BIRD contains a simple programming language,
so filter rules are programs.
When a route is being passed between protocols and routing tables, 
the corresponding filter will be are interpreted by BIRD.
The filter will get the route, so it can inspect the route,
the attributes, and make changes to the route if needed. 
At the end, the filter decides
whether to pass the route through (using \texttt{accept}) 
or reject it (using \texttt{reject}). 
More filter examples will be provided later.



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The \texttt{static} Protocol} 

A special type of protocol is called \texttt{static}, which is 
useful in our BGP attack task. Just like the other special
types of protocols, this protocol is not a real protocol either.
It does not import routes from a peer, instead, it provides 
predefined routes that need to be imported into 
the routing table. Each route can have a route-specific
filter. This is especially useful for configuring route attributes. 

When specifying a route, we can either specify a router, or 
specifying a special target name, indicating the actions 
that need to be performed on the matching packets. 
A target name is \texttt{blackhole},
indicating that packet to the specified destination should be 
dropped. See the following example.

\begin{lstlisting}
protocol static {
    ipv4 {
        table t_bgp;  # Connect to a non-default routing table
    };
    route 10.152.0.0/24 via 10.3.0.100 { ... filter ... };
    route 10.153.0.0/24 blackhole { ... filter ... };
}
\end{lstlisting}



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The Pipe Protocol} 

For IPv4, only the route stored in BIRD's master table \texttt{master4} will be eventually
exported to the kernel's routing table (via the \texttt{kernel} protocol). 
If we specify a customized table
inside a protocol, the routes will not be stored in \texttt{master4},
and will therefore not affect the routing. We need to tell BIRD
to export the routes in those tables to the master table. This is done 
through another special type of protocol called \texttt{pipe}. 

The Pipe protocol links two routing tables, a primary table (specified using
the \texttt{table} keyword) and a secondary table (specified using 
the \texttt{peer} keyword). Filters can be specified for the import
and export directions. In the following example, all the entries
in the \texttt{t\_bgp} table are exported to the \texttt{master4} table,
while none of the routes in the \texttt{master4} are imported. 

\begin{lstlisting}
protocol pipe {
    table t_bgp;
    peer table master4;
    import none;
    export all;
}
\end{lstlisting}

In the following example, all the route entries from the \texttt{t\_direct}
table are ported to the \texttt{t\_bgp} table, and the local preference
attribute of the routes are set to \texttt{40}.

\begin{lstlisting}
protocol pipe {
    table t_direct;
    peer table t_bgp;
    import none;
    export filter { bgp_local_pref = 40; accept; };
}
\end{lstlisting}
 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{BGP Large Communities} 


When a BGP router sends routes to its peers, they do not send all the routes they
know. What routes are sent depends on many factors, such as the
region of the peers, the business relationship between the peers, 
and policies. To help BGP routers make such decisions, additional 
information needs to be attached to each route.
The BGP communities are created to serve this goal.


BGP communities are attribute tags that can be applied to incoming or outgoing prefixes to
achieve some common goal~\cite{rfc1997}. For example, ISP can label the incoming routes 
from a particular autonomous system with a special attribute value, 
so when it forwards the route to its peers, it can choose to forward
the routes only to a particular set of peers (hence the community). 
The BGP community attribute makes it convenient to enforce such a policy.

The original BGP communities standard was originally proposed in RFC1997~\cite{rfc1997},
but it has limitations. That is why the BGP Large communities 
standard was proposed~\cite{rfc8195}. 
BGP Large Communities are composed of three 4-byte integers.
Using the canonical notation this format can be summarized 
as ``ASN:Function:Parameter''.

\begin{itemize}
\item The first integer is the Global Administrator field, whose value is the
   Autonomous System Number (ASN) of the AS that has defined the meaning
   of the remaining two 4-octet fields. Since ASN is unique, 
   each community is unique globally.

\item The second integer is the function identifier. This field defines
  the meaning of the community. Each AS can define their own
  functions. 

\item The third integer is the parameter value. 
\end{itemize}
 
There are many applications of the BGP Large Communities, such as 
identifying routes by their geographically locations (countries, 
continent etc.), the business relationships between peers (customers,
providers, or peers), and many other aspects. When exporting and importing 
routes, actions can be applied to these routes based on which
communities they belong to. RFC 8195 provides many 
examples~\cite{ref8195}.

\paragraph{BGP large communities defined in our setup.}
In our Internet emulator, we use the BGP large communities to 
capture the business relationships among peers. These relationships
will affect how a route is exported to peers. 
Let's use AS-150 as an example to show how the BGP large communities are used
in our setup. In this autonomous system, we defined four communities. 

\begin{lstlisting}
define LOCAL_COMM    = (150, 0, 0);   # large community value: 150:0:0
define CUSTOMER_COMM = (150, 1, 0);   # large community value: 150:1:0
define PEER_COMM     = (150, 2, 0);   # large community value: 150:2:0
define PROVIDER_COMM = (150, 3, 0);   # large community value: 150:3:0
\end{lstlisting}

When we import or export a route, using filters,
We can add communities to a route, or delete communities from it. 
We can also check whether a route belongs to a community or not. See the 
following examples. We will use them in our export and import filters. 

\begin{lstlisting}
# Check whether the route belongs to a community
if ((150, 1, 0) ~ bgp_large_community) then return true;

# Delete community from the route
bgp_large_community.delete([(150, *, *)]);
bgp_large_community.delete([(150, 2, 0)]);

# Add community to the route
bgp_large_community.add((150, 0, 0));
bgp_large_community.add([(150, 1, 0), (150, 2, 0)]);
\end{lstlisting}
 


\paragraph{The Local community.}
As we have discussed earlier, in the BGP setup, 
the \texttt{direct} protocol is used to generate the routes
to the local networks. These routes are put inside
the \texttt{t\_direct} table first, and then they
will be exported to the \texttt{t\_bgp} table (containing
all the BGP routes) through a pipe. 
A filter is applied during the exporting, so the 
routes are tagged with the \texttt{LOCAL\_COMM}
community, indicating that the routes are locally 
generated. 

\begin{lstlisting}
protocol pipe {
    table t_direct;
    peer table t_bgp;
    import none;
    export filter { bgp_large_community.add(LOCAL_COMM); ... };
}
\end{lstlisting}


\paragraph{The Provider and Customer communities.}
Let us look at the peering between AS-150 and AS-2. 
AS-2 is a transit AS, which is the Internet service provider 
to AS-150. In the real world, AS-150 will pay AS-2 to get the service. Therefore, 
in AS-150's BGP configuration, the routes from AS-2 are put
in the \texttt{PROVIDER\_COMM} community, indicating that
the routes are from the provider. 
Correspondingly, in AS-2's BGP configuration, all the routes
from AS-150 are put in the \texttt{CUSTOMER\_COMM} community. 

\begin{lstlisting}
protocol bgp u_as2 {
    ipv4 {
        table t_bgp;
        import filter {
            bgp_large_community.add(PROVIDER_COMM);
	    ...
        };
        export where bgp_large_community ~ [LOCAL_COMM, CUSTOMER_COMM];
    };
    ...
}
\end{lstlisting}

Using the community information, an autonomous system
can now enforce the policies corresponding to its relationship with
peers. As a provider to AS-150, AS-2 is obligated to serve as the 
transit for AS-150's networks and its customer's networks (in our setup, 
AS-150 is a stub AS, so it does not have customers). 
This policy is enforced from the export filter of AS-150. We can see
that AS-150 only exports the routes from the 
\texttt{LOCAL\_COMM} and \texttt{CUSTOMER\_COMM} communities to AS-2.
This means, only the routes locally generated by or the routes 
from AS-150's customers are sent to AS-2. Routes in other 
communities (such as the Peer community discussed below)
will not be sent to AS-2.


\paragraph{The Peer community.}
AS-150 also peers with another stub autonomous system AS-151, but they 
are not in a provider-to-customer peering relationship. 
They peer with each other so the traffic between them
can go to each other directly, instead of going through another 
autonomous system. This is for mutual benefit, so
typically they do not pay each other. 

Because of this kind of business relationship, they do not want to
become a provider to the other. How they forward the routes to each other 
will be based on the peer-to-peer policy, 
not on the provider-to-customer policy. Let's see how such a policy
can be enforced using the BGP large communities. 
Here is the peering configuration between AS-150 and AS-151:

\begin{lstlisting}
protocol bgp p_as151 {
    ipv4 {
        table t_bgp;
        import filter {
            # Put the route in the PEER_COMM community
            bgp_large_community.add(PEER_COMM);
            ...
        };
        # Only export the routes from the specified communities
        export where bgp_large_community ~ [LOCAL_COMM, CUSTOMER_COMM];
    };
    ...
}
\end{lstlisting}

When two autonomous systems are in the peer-to-peer relationship, none of them
will will serve as the transit for the others in either upstream or 
downstream directions. Here is how this is achieved using the BGP 
large communities.

\begin{itemize}
  \item When AS-150 exports routes to AS-151, it only exports the routes
    from these two communities: \texttt{LOCAL\_COMM} and \texttt{CUSTOMER\_COMM}.
    Namely, it only exports the routes belonging to itself and its 
    customers (it does not have customers in our setup). It will not export the 
    routes from AS-2 to its peer AS-151, because those routes are put in the 
    \texttt{PROVIDER\_COMM} community (see the peering setup with AS-2).
    Therefore, even though AS-150 can reach the rest of the Internet via AS-2,
    it does not tell AS-151, so AS-151 will never use AS-150 to reach the 
    Internet even if AS-151 loses its connection with its own Internet service
    providers. This policy essentially prevents AS-151 from using AS-150 
    as a upstream transit to reach the Internet.


  \item When AS-150 import routes from AS-151, it put the routes in
    the \texttt{PEER\_COMM} community. Based on the export 
    filter defined in the peering with AS-2, 
    AS-150 only exports the routes belonging to itself and its 
    customers to AS-2, not the routes in the \texttt{PEER\_COMM} community. 
    Therefore, so even though AS-150 can reach AS-151, it does not announcement that
    AS-2, so AS-2 will never route the AS-151 bound packets to AS-150, 
    essentially preventing AS-2 from using AS-150 as 
    a downstream transit to reach AS-151.
\end{itemize}
 


% *******************************************
% SECTION
% *******************************************
\section{Task 1: Stub Autonomous System} 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 1.a: Understanding AS-155's BGP Configuration} 

Please study the BGP configuration on AS-155, and answer the following question:

\begin{itemize}
  \item Study the BGP configuration file, and understand how it
    peer with others. Do not worry about the filtering part.
    What ASes does AS-155 peer with? 

  \item AS-155 peers with both AS-2 and AS-4, so if AS-155
    loses the connection with one of them, it can still connect
    to the Internet. Please design an experiment to 
    demonstrate this. You can enable/disable BGP sessions
    either from the \texttt{birdc} command or from the 
    graph. In your experiment, please show 
    how the routing table changes when a particular 
    BGP session is disabled. 
\end{itemize}



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 1.b: Experimenting with Large Communities} 

Due to some technical issue, the connection between AS-4 and AS-156 is broken. 
Since AS-4 is the only service provider for AS-156, this essentially
disconnects AS-156 from the Internet. However, AS-156 still peers with AS-155, 
which is still connected to the Internet, so why is AS-156 not able to 
connect to the Internet?  

While AS-156 and AS-4 are trying to solve the problem, AS-156 holds an 
emergency meeting with AS-155, agreeing to pay AS-155, so its 
traffic can temporarily go through AS-155 to reach the Internet. 
This requires some changes on AS-155's BGP router. 
Please make such changes, so AS-155 can temporarily 
provide a transit service to AS-156.


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 1.c: Observing BGP Update} 

Run \texttt{tcpdump} on another BGP router, use it to monitor the BGP traffic.
Identify the update and withdraw message. When would a withdraw message be 
triggered and when would an update message be triggered? 

\begin{lstlisting}
# ip address

# tcpdump -n -i ix105 -vvvvv port 179
\end{lstlisting}
 
% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 1.d: Configuring AS-180} 

AS-180 is already included in the emulator. It connects to the
IX105 Internet exchange (Houston), but it does not peer with anybody, 
so it is not connected to the Internet. 
In this task, students need to do the following:

\begin{itemize}[noitemsep]
  \item Peer AS-180 with AS-171, so they can directly reach each other
  \item Peer AS-180 with the AS-2 and AS-3 transit autonomous systems, so they can
    reach other destination via these transits.
\end{itemize}


In your lab report, please include the content you add to the 
BIRD configuration file, and provide proper explanation.
Please also include screenshots (such as traceroute) to demonstrate 
that your task is successful. 


% *******************************************
% SECTION
% *******************************************
\section{Task 2: Transit Autonomous System} 

If two ASes want to connect, they can peer with each other
at an Internet exchange point. The question is how two ASes in two different locations
get connected to each other. It is hard for them
to find a common location to peer. To solve this problem,
a special type of AS is needed.

This type of AS have BGP routers in many Internet
Exchange Points, where they peer with many other ASes. Once packets get into
its networks, they will be pulled from one IX to another IX (typically via
some internal routers), and eventually
hand it over to another AS. This type of AS provides the transit
service for other ASes. That is how the hosts in one AS can reach the hosts in
another AS, even though these ASes are not peers with each other.
This special of AS is called \textit{Transit AS}.
In this task, we will first understand how a transit AS works and
then we will configure a transit AS in our Internet emulator.  


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Reading: Understanding IBGP} 

Just like the peering of BGP routers from different
autonomous systems, for the BGP routers in the same
autonomous systems to exchange information, they
also need to peer with each other and run the BGP
protocol to exchange information.
The BGP protocol conducted by the BGP routers
inside the same AS is called IBGP (Internal BGP).

When we establish a BGP session between two routers with the same ASN, it will be considered
as an IBGP session, and when the session is between two routers with different ASNs, the session
is considered as an EBGP session (External BGP).
Therefore, the way to define
an IBGP session is the same as defining an EBGP session.
However IBGP sessions have several different behaviors 
than the EBGP sessions.


\begin{itemize}
\item In IBGP sessions, when sending routes to peers,
routers will not prepend their own ASN in the \texttt{AS\_PATH},
and the \texttt{nexthop} attribute will not be altered either.

\item RFC 4271 prohibits the advertisement of the routes received from 
an IBGP peer to another IBGP peer; otherwise, there will be a loop.
This is because IBGP does not add their own information
to the AS path, BGP routers will not be able to know whether
their peers already know the AS path or not. If forwarding
is enabled, a BGP router will keep forwarding information
to their peers, creating loops. 
Because there is no forwarding, 
RFC 4271 states that all the BGP routers within a single AS must be 
fully meshed, i.e., all BGP routers peer with one another internally.
\end{itemize}


Let's use AS-3 to understand how the IBGP peering works inside 
this transit AS. 
This AS has four BGP routers, and we pick the one 
connected to the IX-103 (Miami) Internet exchange.
The following is the IBGP configuration on this router:

\begin{lstlisting}
protocol bgp ibgp1 {
    ipv4 {
        table t_bgp;
        import all;
        export all;
        igp table t_ospf;
    };
    local    10.0.0.7 as 3;
    neighbor 10.0.0.6 as 3;
}
protocol bgp ibgp2 {
    ipv4 {
        ... same is ibgp1 ...
    };
    local    10.0.0.7 as 3;
    neighbor 10.0.0.5 as 3;
}
protocol bgp ibgp3 {
    ipv4 {
        ... same is ibgp1 ...
    };
    local    10.0.0.7 as 3;
    neighbor 10.0.0.8 as 3;
}
\end{lstlisting}


\paragraph{Loopback interface.}
A BGP router has multiple IP address (one for each network interface), so which IP address
should be used in the IBGP peering? Any of the IP addresses will work, but 
if we use the IP address of a particular network interface, if that interface 
goes down or get disabled, the IP address become unreachable, and the 
peering using the IP address will fail. 

To solve this problem, it is suggested that a loopback interface is used 
in the IBGP peering. The loopback interface is virtual and always stays up. 
Therefore, the IGBP session can still remain intact even if some other 
interfaces fail. In the event of link failure, the interior routing 
protocol will automatically find an alternate path to the peer's loopback
IP address. 

In the configuration, each of the \texttt{10.0.0.x/32} addresses is 
the IP address of the loopback interface (called \texttt{dummy} in our setup). 
These addresses are announced via the OSPF routing protocol, so all the 
routers inside the same AS know how to reach these addresses. 



\paragraph{The \texttt{NEXT\_HOP} attribute.}
When a BGP router sends a route to an internal BGP peer that is multiple hops
away, the \texttt{NEXT\_HOP} route attribute makes no sense to the peer, 
because this next hop (assuming it is \texttt{X}) is the addresses of a 
boundary routers directly connected to the sender, not the receiver. 
The peer must figure out what the immediate next hop is in order to reach \texttt{X}, 
and the distance to \texttt{X} (for path selection purpose). 

To achieve that, after receiving a route from an internal BGP peer,
the BGP router will do a route lookup using a routing table.
This routing table is an IGP routing table containing the AS-internal routes. 
The \texttt{igp table} entry specifies this IGP routing table. 



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 2.a: Experimenting with IBGP} 


For the task, we first need to find some traffics that 
go through AS-3. We will ping \texttt{10.164.0.71} from a host in AS-162. Using the 
map client program, we can see that the packets go through
the AS-3 transit AS. If this is not consistent with your observation,
do find some other traffics that go through AS-3. 

We will now disable the IBGP sessions either the map client or 
from the command line. See the following example.

\begin{lstlisting}
bird> show protocols
Name       Proto      Table      State  Since         Info
...
ibgp1      BGP        ---        up     20:19:03.800  Established
ibgp2      BGP        ---        up     20:19:11.921  Established
ibgp3      BGP        ---        up     20:20:50.238  Established

bird> disable ibgp3 
bird> show protocols ibgp3
Name       Proto      Table      State  Since         Info
ibgp3      BGP        ---        down   20:26:44.526
\end{lstlisting}
 
Before disabling IBGP, show the routing table 
on the BGP router (using \texttt{"ip route"}). Compare the 
results before and after disabling IBGP, and explain
your observations. 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Reading: Understanding IGP} 

Routers inside an autonomous system need to
communicate with each other, so they can tell each other
what networks they are connected to, so others can figure out
the best path to get to those networks. That is what
was missing in the previous task.


This type of routing protocol is called IGP (Interior Gateway Protocol).
There are several IGP protocols, including OSPF (a link state routing protocol) and RIP (a
distance-vector routing protocol). BIRD supports both of them. In this
task, we will only use the OSPF protocol.

Let us add the OSPF protocol to our BIRD configuration file. In the following,
we create a \texttt{"protocol ospf"} block and specify a table called \texttt{t\_ospf}.
That means all the OSPF routing information will be stored in
this table. Inside the \texttt{"protocol bgp ibgp"} block, we tell BIRD to
use the \texttt{t\_ospf} table to resolve the nexthop for
the route obtained from the internal BGP peers.

\begin{lstlisting}
table t_ospf;  # Define a new table 
ipv4 table t_ospf;
protocol ospf ospf1 {
    ipv4 {
        table t_ospf;
        import all;
        export all;
    };
    area 0 {
        interface "ix104" { stub; };
        interface "net_103_104" { hello 1; dead count 2; };
    };
}

# Create a pipe between the OSPF and master tables. 
protocol pipe {
    table t_ospf;
    peer table master4;
    import none;
    export all;
}
\end{lstlisting}

Detailed configuration of OSPF can be quite complicated, and it is beyond the
scope of this lab.
An area with ID 0 is called a backbone area. All other areas need
to be connected to the backbone area. In our configuration, we put all routes
in the backbone area to make things simple. This
particular BGP router (\texttt{AS2}'s router in \texttt{IX100})
is connected to two networks, one through \texttt{eth0} and the other
through \texttt{eth1}.

Information from both networks will be included in the OSPF protocol,
so others know how to reach these two networks. However,
while \texttt{eth0} is connected to the internal network,
\texttt{eth1} is the interface used by the router
to connect to an outside network, the IXP's network. This network is provided
by IXP for peering purposes. We do need to include this network in the OSPF
protocol, so the internal router knows how to reach this network. However, we
will not run OSPF protocol with anybody on this network, because they
do not belong to \texttt{AS2}; they are outsiders.
You do not want to leak the internal network information to the outside;
nor do you want the outsider to manipulate your internal routes using OSPF.
Therefore, you should not run the OSPF protocol with
the routers on this external network.
You only run OSPF with the internal routers.
That is why we use \texttt{stub}, meaning the information from this network
will be used in the OSPF protocol, but we will not run OSPF on
this network.

Explain the \texttt{hello 1; dead count 2;} part. 



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 2.b: Experimenting with IGP} 

In this task, we will disable the OSPF routing protocol, and see 
how it affects the routing. There are several ways to disable
OSPF. One way is to do it inside \texttt{birdc}: 

\begin{lstlisting}
# bridc
birdc> show protocols
...
ospf1      OSPF       t_ospf     up     19:49:43.343  Running
...

birdc> disable ospf1
birdc> show protocols ospf1
ospf1      OSPF       t_ospf     down   19:57:37.187
\end{lstlisting}
 
Another way is to modify the \texttt{bird.conf} configuration file,
changing the \texttt{"import/export all"} to 
\texttt{"import/export none"}. This will keep OSPF running, but  
no routes obtained from the protocol will be used. 

\begin{lstlisting}
protocol ospf ospf1 {
    ipv4 {
        table t_ospf;
        import none;  (*@\pointleft{import no route from peer}@*) 
        export none;  (*@\pointleft{export no route to peer}@*) 
    };
    ...
}
\end{lstlisting}
 

\paragraph{Task.} We pick AS-3 transit autonomous system in this 
task. This AS has four BGP routers, and we pick the one 
connected to the IX-103 (Miami) Internet exchange.
For the task, we also need to find some traffics that 
go through AS-3. 
We will ping \texttt{10.164.0.71} from a host in AS-162. Using the 
map client program, we can see that the packets go through
the AS-3 transit AS. If this is not consistent with your observation,
do find some other traffics that go through AS-3. 


We will now disable the OSPF using one of the methods mentioned above.
Before disabling OSPF, show the routing table 
on the BGP router (using \texttt{"ip route"}). Compare the 
results before and after disabling OSPF. Based on the 
observation, explain why the IGP is essential for the transit 
autonomous systems. 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Task 2.c: Configuring AS-5} 

The transit autonomous system AS-5 is already included in the emulator. 
It connects to three 
Internet exchanges: IX-101, IX-103, and IX-105 Internet exchange,
but it does not peer with anybody. Its topology can be found 
in Figure~\ref{bgp:fig:as5}.
In this task, students need to conduct the following tasks:

\begin{itemize}[noitemsep]
  \item Establish the IBGP inside AS-5 (this part is already created 
    inside the emulator, so we need to remove it before giving the container 
    files to students). The OSPF is also created, but we will keep it. 

  \item Peer AS-5 with AS-153, AS-160, AS-171, with AS-5 being their service provider.

  \item Peer AS-5 with the AS-3 at IX-103 (Miami). Since they are both Tier-1 ASes,
    they don't pay each other, and their relationship is peer-to-peer.
\end{itemize}


In your lab report, please include the content you add to the 
BIRD configuration file, and provide proper explanation.
Please also include screenshots (such as traceroute) to demonstrate 
that your task is successful. 


% *******************************************
% SECTION
% *******************************************
\section{Task 3: Path Selection} 

BGP routers typically receive multiple routes to the same network. 
All these routes will be kept, but BGP will run a best route 
selection algorithm to choose one route as the current best route. 
This route will be the one announced to the peers; 
it is also the one given to the kernel routing table, 
so routing is based on this selected route. 
When the best route is retracted, BGP router re-runs the 
best route selection algorithm to find the current best route. 


Although different BGP software may implement the path selection
differently, they mostly follow the similar order. The following
lists the first four criteria used by most algorithms.

\begin{enumerate}[noitemsep]
  \item Prefer the path with the highest weight. 
  \item Prefer the path with the highest local preference.
  \item Prefer the path that was locally originated via a network or 
        aggregate BGP subcommand or through redistribution from an IGP.
  \item Prefer the path with the shortest AS path. 
\end{enumerate}

The top-2 criteria used by BIRD is the following:
(1) prefer route with the highest Local Preference attribute,
(2) prefer route with the shortest AS path. In this task, we will
experiment with these two criteria, and see how they affect 
the path selection. 


\paragraph{Task 3.a.} The \texttt{"birdc show route all > all-routes"} command
can list all the BGP routes (the output is quite long, so it is better to
save the output to a file). The \texttt{"ip route"} command
can list all the entries in the kernel routing table. 

Go to AS-150's BGP router, and show all the BGP routes. Find a network prefix
that has more than one routes. Explain their differences. Compare these 
routes to the entries in the kernel routing table, and identify which route is 
selected as the best route, and explain why this route is selected? 


\paragraph{Task 3.b.}
AS-150 peers with both AS-2 and AS-3, which provides the 
Internet services to AS-150.
However, because the link to AS-2 is slower than
the link to AS-3, AS-150 wants 
to use AS-2 only as the backup upstream link, i.e., traffic
from AS-150 should always use AS-3, unless the link is broken.
Please use two different ways to achieve this goal: 
(1) setting the local preference, 
(2) penalizing the path from AS-2 by artificially
increasing the length of the AS paths from AS-2.


The following filter example shows how to set the
local preference for a route, and how to prepend 
additional ASes (AS-2 is used in this example) to 
the route's AS path.

\begin{lstlisting}
filter {
    bgp_local_pref = 10;
    bgp_path.prepend(2);
    bgp_path.prepend(2);
    accept;
};
\end{lstlisting}
 


% *******************************************
% SECTION
% *******************************************
\section{Task 4: IP Anycast} 

Provide the AS (IP address T is an IP anycast address). 
Ask students to conduct the following experiment:

\begin{itemize}
  \item Inspect the BGP route table to identify the route.
  \item From A and B, ping T. They get to two different T.
  \item Break a BGP session, so they get to the same T.
  \item Use UDP instead of ping.
\end{itemize}
 


% *******************************************
% SECTION
% *******************************************
\section{Task 5: BGP Attacks} 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{BGP Session Reset Attack} 



Countermeasure: TTL security switch (RFC 5082).
Design an experiment to demonstrate its effect.

\begin{lstlisting}
protocol bgp c_as12 {
    ipv4 {
        table t_bgp;
        import filter {
	   ...
        };
        export all;
        next hop self;
    };
    local 10.104.0.3 as 3;
    neighbor 10.104.0.12 as 12;
    ttl security;
}
\end{lstlisting}
 

% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{IP Prefix Hijacking} 



\begin{lstlisting}
protocol static hijacks {
    ipv4 {
        table t_bgp;
    };
    route 10.153.0.0/25 blackhole   { bgp_large_community.add(LOCAL_COMM); };
    route 10.153.0.128/25 blackhole { bgp_large_community.add(LOCAL_COMM); };
}
\end{lstlisting}
 


% *******************************************
% SECTION
% ******************************************* 
\section{Submission}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{\commonfolder/submission}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}



