%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Copyright by Wenliang Du.                                       %%
%%  This work is licensed under the Creative Commons                %%
%%  Attribution-NonCommercial-ShareAlike 4.0 International License. %%
%%  To view a copy of this license, visit                           %%
%%  http://creativecommons.org/licenses/by-nc-sa/4.0/.              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\commonfolder}{../../common-files}

\input{\commonfolder/header}
\input{\commonfolder/copyright}


\lhead{\bfseries SEED Labs -- BGP Exploration and Attack}
\newcommand{\bgpFigs}{./Figs}

\begin{document}


\begin{center}
{\LARGE BGP Exploration and Attack Lab}

  \vspace{0.1in}
  {\LARGE (Work in Progress)}
\end{center}

\seedlabcopyright{2021}



% *******************************************
% SECTION
% ******************************************* 
\section{Overview}

Border Gateway Protocol (BGP) is the standard exterior gateway protocol
designed to exchange routing and reachability information among autonomous
systems (AS) on the Internet. It is the ``glue'' of the Internet,
and is an essential piece of the Internet infrastructure. It is 
also a primary attack target, because if attackers can 
compromise BGP, they can disconnect the Internet and redirect traffics. 

Because of the complexity of BGP, it is hard to do everything in a single lab. 
Therefore, we have developed a series of labs related to BGP. This lab
is the first in the series, and it is the basis for all the other BGP labs.  
The goal of this lab is to help students understand how
BGP ``glues'' the Internet together, and how the Internet is actually
connected. In this lab, we guide students to build a small-scale Internet.
We call this Internet the Internet Simulator (or simply
Simulator in short). This simulator will be the basis for 
all other BGP labs, as well as for some non-BGP labs that 
depends on the Internet. 
This lab covers the following topics:
\begin{itemize}[noitemsep]
\item How the BGP protocol works
\item BGP configuration
\item Routing 
\item Internet Exchange Point (IXP)
\item BGP attack
\end{itemize}


\paragraph{Videos.}
Detailed coverage of the BGP protocol can be found in 
Section 10 of the SEED Lecture at Udemy, \seedisvideo 
The lecture was recorded before this lab was developed; 
it focuses mostly on the theory part, i.e., explaining how the BGP protocol works. 
This lab provides the practical part.  


\paragraph{Lab environment.} 
\seedenvironmentB
\nodependency


\paragraph{Acknowledgment.} 
This lab was developed with the help of Honghao Zeng, a graduate student
in the Department of Electrical Engineering and Computer Science at Syracuse University.
The SEED project is funded by the US National Science Foundation. 


% *******************************************
% SECTION
% *******************************************
\section{The Internet Emulator} 

This lab will be performed inside the SEED Internet Emulator. We will
provide a pre-built emulator in two different forms: (1) Python code,
and (2) container files. The container files are generated from
the Python code. However, students need to install the SEED Emulator source 
code from the GitHub to run the Python code. The container files
can be directly used without the Emulator source code. 

Instructors who would like to customize the emulator can modify the Python
code, generate their own container files, and then provide these
container files to students, replacing the ones included in the 
setup file. 



% *******************************************
% SECTION
% *******************************************
\section{Understanding the Configuration in BIRD} 

The routing software used in this lab is called BIRD, which is 
an acronym standing for ``BIRD Internet Routing Daemon''~\cite{bird}.
It is open source under the GNU General Public License. It 
supports a number of standard routing protocols, including 
the Border Gateway Protocol (BGP),
the Routing Information Protocol (RIP),
and the Open Shortest Path First protocol (OSPF). We will
mainly use BGP and OSPF in this lab. 


BIRD takes the configuration
file \texttt{bird.conf} from the \texttt{/etc/bird/} folder.
In this lab, students need to understand the entries in the 
configuration file. Students also need to make changes
to the file for some tasks. In this section, we provide 
a tutorial to help students understand the 
configuration file. It should be noted that the actual configuration
for BIRD is quite complicated, and most configuration entries 
are protocol specific. Full details of the configuration 
can be found in the BIRD manual~\cite{birdmanual}.



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Routing Tables} 


BIRD has has several routing tables in memory. It uses
the term ``protocol'' to specify how 
to connect a routing table with another entity. Exactly
what entity is connected to depends on the type of the protocol.

If the protocol is a routing protocol, 
such as BGP, OSPF, or RIP, the entity will be an external router.
Namely, the routes received from the external router
are imported to the routing table, while 
the routes stored in the routing table are exported 
to the external router.

Some protocols used in BIRD are not not real protocols; 
BIRD simply uses the keyword \texttt{protocol} to specify where
a BIRD routing table gets its routes from, and where the routes
in the table need to be sent to.

% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Several Special Protocols} 

BIRD has a few special types of ``protocol'', which are not
real protocols, however, they do generate route information,
except that the generation is not through a protocol. 
The followings
are the three important ``fake'' protocols:

\begin{lstlisting}[caption={The \texttt{bird.conf} file for \texttt{AS150}}]
protocol device {
}

protocol direct {
    interface "eth0";
}

protocol kernel {
    import none;
    export all;
}
\end{lstlisting}

To define a routing protocol in BIRD, we use the \texttt{protocol} keyword.
BIRD supports many different routing protocols, like BGP and OSPF. A
\texttt{protocol} can import or export routes to the BIRD's routing table.
For this lab, we will use either \texttt{all} or \texttt{none}. In future
BGP labs, we will introduce filters here, so you can set up
rules to decide what routes can be imported or exported.

\begin{itemize}

\item The \texttt{device protocol} is not a real routing protocol. It doesn't
generate any route, nor does it accept any route. It is only used to get
information about the network interfaces from the kernel. Without the
\texttt{device protocol}, BIRD will know nothing about the network
interfaces; it will not even be able to run BGP, as it does not know how
to reach BGP peer's IP address. Therefore, this block is mandatory.

\item The \texttt{direct protocol} is for generating routes for the directly
connected networks from a list of interfaces. In the \texttt{direct protocol}
block, the \textit{interface} keyword is used to generate routes from an
interface. In this case, \texttt{AS150}'s bgp router uses \texttt{eth0} to
connect to \texttt{AS150}'s internal network (\texttt{10.150.0.0/24}).
Therefore, this \texttt{direct protocol} block will generate a routing
entry for \texttt{10.150.0.0/24}. BGP will announce this network
prefix to the peers.

\item The \texttt{kernel} protocol is not a real routing protocol like BGP or
OSPF. Instead of communicating with other routers in the network, it connects
BIRD's routing table to kernel's routing table. It is the kernel's routing table
that is used in the actual routing, not BIRD's routing table.
This protocol is used to set the kernel routing table using the routes
received from BGP peers. Here
\texttt{import none} means BIRD's routing table will not import anything from
the kernel's routing table; \texttt{export all} means BIRD's routing table
will export all the routes to the kernel's routing table. This is how BGP
routers set the routing table using the data collected from the BGP
protocol.
\end{itemize}


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The Static Protocol} 

A special type of protocol is called \texttt{static}, which is 
useful in our BGP attack task. Just like the other special
types of protocols, this protocol is not a real protocol either.
It does not import routes from a peer, instead, it provides 
predefined routes that need to be imported into 
the routing table. Each route can have a route-specific
filter. This is especially useful for configuring route attributes. 

When specifying a route, we can either specify a router, or 
specifying a special target name, indicating the actions 
that need to be performed on the matching packets. 
A target name is \texttt{blackhole},
indicating that packet to the specified destination should be 
dropped. See the following example.

\begin{lstlisting}
protocol static {
    ipv4 {
        table t_bgp;  # Connect to a non-default routing table
    };
    route 10.152.0.0/24 via 10.3.0.100 { ... filter ... };
    route 10.153.0.0/24 blackhole { ... filter ... };
}
\end{lstlisting}



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The BGP Protocol} 

The most important protocol relevant to this lab is the BGP protocol.
This is a real protocol. For each BGP peering, an instance of 
such a protocol needs to be specified in the BIRD configuration 
file. The protocol connects a routing table with another 
BGP router, i.e., it imports/exports rules from/to 
the peer specified in the protocol.
See the following example. 

\begin{lstlisting}
protocol bgp xyz {
    local    10.104.0.3   as 3;
    neighbor 10.104.0.104 as 104;     (*@\pointleft{BGP peer}@*)
    ipv4 {
        table t_bgp;
        import all;        (*@\pointleft{all the routes from peer will be imported}@*)
        export filter {    (*@\pointleft{export selected routes to peer}@*)
           if proto = "static" then reject;
           accept;
        };
    };
}
\end{lstlisting}

The \texttt{local} option in the BGP protocol sets the local IP address and ASN of the BGP session.
The syntax is \texttt{"local [ip\_address] as <asn>"}. The \texttt{[ip\_address]} part is optional,
but it makes the configuration looks clearer and can prevent selecting the wrong IP address for the
BGP session when there are multiple IP addresses on the router. This
IP address should be the one on the IX's network.

The \texttt{neighbor} option in the BGP protocol sets the neighbor IP address and ASN of the BGP
session. This is the actual peering part. In this example, we set up a BGP session
between \texttt{AS3} and \texttt{AS104}, so they can exchange route information using the BGP protocol.
Similarly, the IP address here should be the one on the IX's network.


\paragraph{Channel and table.}
Each protocol is connected to a routing table through a channel. 
BGP supports both IPv4 and IPv6 channels. 
Each channel has two filters, export and import filters, 
which can accept, reject and modify the routes. 
The export filter applies to the routes going from the routing table to the protocol, 
while the import filter applies to the routes coming into the routing table. 

In the example above, the routing table in the IPv4 channel is 
specified (\texttt{t\_bgp}). If no table is specified, the 
default table used is \texttt{master4} (for IPv6, it is \texttt{master6}). The 
\texttt{master4} table is BIRD's master routing table for IPv4 routes. It should 
be noted that this table is not the operating system's routing table, i.e.,
it is not the one used for the actual routing. The one used for the actual
routing is called the kernel routing table. The \texttt{kernel} protocol
described earlier specifies how the routes in  BIRD's master routing
table are exported to the kernel routing table. 

\paragraph{Filter.}
When importing/exporting routes to/from the routing table, 
filter rules can be applied. BIRD contains a simple programming language,
so filter rules are programs.
When a route is being passed between protocols and routing tables, 
the corresponding filter will be are interpreted by BIRD.
The filter will get the route, so it can inspect the route,
the attributes, and make changes to the route if needed. 
At the end, the filter decides
whether to pass the route through (using \texttt{accept}) 
or reject it (using \texttt{reject}). 
Here are some filter examples:


\begin{lstlisting}

\end{lstlisting}
 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The Pipe Protocol} 

For IPv4, only the route stored in BIRD's master table \texttt{master4} will be eventually
exported to the kernel's routing table (via the \texttt{kernel} protocol). 
If we specify a customized table
inside a protocol, the routes will not be stored in \texttt{master4},
and will therefore not affect the routing. We need to tell BIRD
to export the routes in those tables to the master table. This is done 
through another special type of protocol called \texttt{pipe}. 

The Pipe protocol links two routing tables, a primary table (specified using
the \texttt{table} keyword) and a secondary table (specified using 
the \texttt{peer} keyword). Filters can be specified for the import
and export directions. In the following example, all the entries
in the \texttt{t\_bgp} table are exported to the \texttt{master4} table,
while none of the routes in the \texttt{master4} are imported. 

\begin{lstlisting}
protocol pipe {
    table t_bgp;
    peer table master4;
    import none;
    export all;
}
\end{lstlisting}

In the following example, all the route entries from the \texttt{t\_direct}
table are ported to the \texttt{t\_bgp} table, and the local preference
attribute of the routes are set to \texttt{40}.

\begin{lstlisting}
protocol pipe {
    table t_direct;
    peer table t_bgp;
    import none;
    export filter { bgp_local_pref = 40; accept; };
}
\end{lstlisting}
 

% *******************************************
% SECTION
% *******************************************
\section{EBGP} 


Pick a BGP router from the emulator. 
Design the following activities.

\begin{itemize}
  \item Start with a stub AS (with two upstream ASes)
  \item Study the BGP configuration file, and understand its entries
  \item Explain the relationships among all the tables, pipe, etc.
  \item Inspect the BGP route table 
  \item Disable/Enable BGP sessions
  \item Simple filter  
  \item Path selection (use the filter to change the other attributes,
    see how it affects the path selection).
\end{itemize}

\paragraph{Advanced features.} 
These are advanced features. Not sure whether they should be included or not.
We temporarily list them here.

\begin{itemize}
  \item Community: label for the route
\end{itemize}




% *******************************************
% SECTION
% *******************************************
\section{Interior BGP (IBGP)} 


\begin{itemize}
  \item Explain the IBGP setup in the configuration 
  \item Inspect the route created by IBGP
  \item Disable OSPF and see the result
\end{itemize}
 


% *******************************************
% SECTION
% *******************************************
\section{IP Anycast} 

Provide the AS (IP address T is an IP anycast address). 
Ask students to conduct the following experiment:

\begin{itemize}
  \item Inspect the BGP route table to identify the route.
  \item From A and B, ping T. They get to two different T.
  \item Break a BGP session, so they get to the same T.
  \item Use UDP instead of ping.
\end{itemize}
 


% *******************************************
% SECTION
% *******************************************
\section{BGP Attacks} 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{BGP Session Reset Attack} 



Countermeasure: TTL security switch (RFC 5082).
Design an experiment to demonstrate its effect.

\begin{lstlisting}
protocol bgp c_as12 {
    ipv4 {
        table t_bgp;
        import filter {
	   ...
        };
        export all;
        next hop self;
    };
    local 10.104.0.3 as 3;
    neighbor 10.104.0.12 as 12;
    ttl security;
}
\end{lstlisting}
 

% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{IP Prefix Hijacking} 



\begin{lstlisting}
protocol static hijacks {
    ipv4 {
        table t_bgp;
    };
    route 10.153.0.0/25 blackhole   { bgp_large_community.add(LOCAL_COMM); };
    route 10.153.0.128/25 blackhole { bgp_large_community.add(LOCAL_COMM); };
}
\end{lstlisting}
 


% *******************************************
% SECTION
% ******************************************* 
\section{Submission}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{\commonfolder/submission}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}



