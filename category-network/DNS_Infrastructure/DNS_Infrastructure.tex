%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Copyright by Wenliang Du.                                       %%
%%  This work is licensed under the Creative Commons                %%
%%  Attribution-NonCommercial-ShareAlike 4.0 International License. %%
%%  To view a copy of this license, visit                           %%
%%  http://creativecommons.org/licenses/by-nc-sa/4.0/.              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\commonfolder}{../../common-files}

\input{\commonfolder/header}
\input{\commonfolder/copyright}
\hypersetup{%
    pdfborder = {0 0 0}
}

\lhead{\bfseries SEED Labs -- DNS Infrastructure}
\newcommand{\dnsFigs}{./Figs}


\usepackage{hyperref}

\begin{document}


\begin{center}
{\LARGE DNS Infrastructure Lab}
\end{center}

\seedlabcopyright{2021}



% *******************************************
% SECTION
% ******************************************* 
\section{Overview}

DNS (Domain Name System) is the Internet's phone book; it
translates hostnames to IP addresses (and vice versa).
This translation is through DNS resolution, which happens behind
the scene. The resolution process involves many nameservers,
including root servers, TLD servers, and final domain servers.
These nameservers form the entire DNS system, which is an
essential infrastructure for the Internet.

To help students understand how these nameservers work together
to form the infrastructure, we will create a miniature DNS system
called \textit{DNS in a Box}. As suggested by its name,
the entire DNS system, which consists of multiple
nameservers, runs inside a single machine. This is made
possible by the container technology.


Even though this system is small, it has all the essential
elements of a real DNS infrastructure. By building such a system,
students will have a deeper understanding of how the DNS actually works.
Although this lab is not a security lab, it is the basis for
several SEED labs. This lab covers the following topics:

\begin{itemize}[noitemsep]
\item DNS and how it works
\item The DNS query process
\item Root and TLD servers
\item Docker container, docker compose
\end{itemize}


\paragraph{Readings and videos.}
Detailed coverage of the DNS protocol can be found in the following:

\begin{itemize}
\item Chapter 18 of the SEED Book, \seedbook
\item Section 7 of the SEED Lecture, \seedisvideo
\end{itemize}


\paragraph{Lab environment.} 
\seedenvironmentB
\nodependency


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\section{The Lab Setup and the SEED Internet Emulator}

This lab will be performed inside the SEED Internet Emulator (simply
called the emulator in this document).
We provide a pre-built emulator in two different forms: Python code
and container files. The container files are generated from
the Python code, but students need to install the SEED Emulator source
code from the GitHub to run the Python code. The container files
can be directly used without the emulator source code.
Instructors who would like to customize the emulator can modify the Python
code, generate their own container files, and then provide the
files to students, replacing the ones included in the
lab setup file.


\paragraph{Download the emulator files.}
Please download the \texttt{Labsetup.zip} file from the web page, and
unzip it. The files inside the \texttt{output/} sub-folder are the actual
emulation files (container files) that are
generated from the Python code \texttt{internet-emulator.py}.


\paragraph{Start the emulation.}
We will directly use the container files in the \texttt{output/} folder.
Go to this folder, and run the following docker commands
to build and start the containers. We recommend that you run the emulator inside
the provided SEED Ubuntu 20.04 VM, but doing it in a generic Ubuntu 20.04 operating system
should not have any problem, as long as the docker software is installed.
Readers can find the docker manual from
\href{https://github.com/seed-labs/seed-labs/blob/master/manuals/docker/SEEDManual-Container.md}
{\underline{this link}}.

\begin{lstlisting}
$ docker-compose build
$ docker-compose up

// Aliases for the Compose commands above (only available in the SEED VM)
$ dcbuild       # Alias for: docker-compose build
$ dcup          # Alias for: docker-compose up
$ dcdown        # Alias for: docker-compose down
\end{lstlisting}








% *******************************************
% SECTION
% *******************************************
\section{Preparation}




% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Get Familiar with the Emulator} 

In this emulator, the DNS infrastructure is formed 
by a number of the containers running DNS nameservers. 
We have customized their container names, so we can easily
list them. All of the containers have the term
\texttt{DNS} in their names. The following command 
can list all of them. 

\begin{lstlisting}
$ dockps | grep DNS
dedc6676421e  as150h-DNS-Root-A-10.150.0.72
84cf7c7f337d  as151h-DNS-COM-A-10.151.0.72
f20fe7ed115f  as152h-DNS-EDU-10.152.0.71
c357ff76bda6  as153h-Global_DNS-1-10.153.0.53
cfabce676bed  as154h-DNS-Example-10.154.0.71
de5dc343224f  as160h-DNS-Root-B-10.160.0.72
20c134dceee4  as161h-DNS-COM-B-10.161.0.72
5801404d45d2  as162h-DNS-AAAAA-10.162.0.72
d65e76c44437  as163h-Global_DNS-2-10.163.0.53

// Get a shell on a selected container
$ docksh cfab   (*@\pointleft{container ID}@*) 
root@cfabce676bed / #
\end{lstlisting}


\paragraph{Set the terminal title.} In this lab,
we need to get into several containers. It will be very difficult 
to know which one is which. To solve this problem, once we 
are inside a container, we can set the terminal title using the 
following command (it sets the title to \texttt{Example.com}). 

\begin{lstlisting}
# NOPRECMD=1 zsh
# set_title Example.com
\end{lstlisting}
 

\paragraph{Copy files.} In this lab, we need to modify the zone files (also
some of the configuration files) inside several containers. We can do that
inside those containers. The problem is that once the containers are stopped
and removed, those changes will be lost. It is better to copy those files
to the hosting machine, make change on the host, and then copy them 
back to the container.  We can use the \texttt{"docker cp"} command
to do that. Since we need to run this command very often, we wrote 
the following shell scripts, one for getting a zone file from container
to the host, and the other for copying the zone file back 
to the container. Both files are included in the lab setup folder.

\begin{lstlisting}[caption=Getting the zone file from container: \texttt{getzone.sh}]
#!/bin/bash

keyword=$1
filename=$2
filename_to=${keyword}_${filename}                                  (*@\lineone@*)
containerID=$(docker ps | grep $keyword | awk '{print $1}')         (*@\linetwo@*) 
if [[ ! -f $filename_to ]]; then
   docker cp $containerID:/etc/bind/zones/$filename ./$filename_to  (*@\linethree@*) 
else
   echo "** File $filename_to already exists; will not overwrite."
fi
\end{lstlisting}

In the emulator, zone files are stored inside the \texttt{/etc/bind/zones} folder.  
Each DNS nameservers have a unique keyword in its container name, for example
the nameserver for the \texttt{example.com} zone has the keyword \texttt{Example}
in its name. We use this keyword to find the corresponding container's ID (see
Line~\linetwo). We also prepend the keyword to the name of the zone file, so we can
easily identify them once they are copied to the host machine (see Lines~\lineone
and~\linethree). The following examples show how we get the zone file from
the two root nameservers and the \texttt{example.com} nameserver.  


\begin{lstlisting}
$ ./getfile.sh Root-A root           (*@\pointleft{}@*) New file: Root-A_root
$ ./getfile.sh Root-B root           (*@\pointleft{}@*) New file: Root-B_root
$ ./getfile.sh Example example.com.  (*@\pointleft{}@*) New file: Example_example.com
\end{lstlisting}
 

Copying files back to  the container is quite similar, except that 
we need to restart the nameserver after the zone file is copied (see Line~\linefour).

\begin{lstlisting}[caption=Sending the zone file to container: \texttt{sendzone.sh}]
#!/bin/bash

keyword=$1
filename=$2
filename_from=${keyword}_${filename}
containerID=$(docker ps | grep $keyword | awk '{print $1}')
if [[ -f $filename_from ]]; then
   echo "== Copy zone file to container"
   docker cp ./$filename_from $containerID:/etc/bind/zones/$filename

   echo "== Restart the nameserver"
   docker exec $containerID service named restart      (*@\linefour@*) 
else
   echo "** File $filename_from does not exists."
fi
\end{lstlisting}
 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{Get Familiar with BIND9's Configuration Files}

In the emulator, the zones hosted by a nameserver are placed 
in the \path{/etc/bind/named.conf.zones} file (multiple zones
can be placed in this file). Here is 
an example, where the \texttt{file} entry specifies
the actual file containing the zone information.  If we want 
to host another zone on this nameserver, we can add a corresponding
zone entry in this file. 

\begin{lstlisting}
zone "example.com" { 
    type master; 
    allow-update { any; }; 
    file "/etc/bind/zones/example.com.";  (*@\pointleft{the actual zone file}@*) 
};
\end{lstlisting}
 
In the emulator, the actual zone files are placed inside the 
\path{/etc/bind/zones} folder. It should be noted that 
most of the zone files (except the root zone) have the \texttt{.} 
at the end of the filename.  This is the main file that we need
to modify in this lab. 


\begin{lstlisting}
$TTL 300               (*@\pointleft{The default time to live: 300 seconds}@*) 
$ORIGIN example.com.   (*@\pointleft{The start of this zone file in the namespace}@*) 
@ SOA ns1.example.com. admin.example.com. (*@\textbf{1635647622}@*) 900 900 1800 60

@                  NS    ns1.example.com.
ns1.example.com.   A     10.154.0.71

www                A     10.154.0.72
abc                A     10.154.0.73 
\end{lstlisting}

The zone file must specify the Start of Authority (SOA) record, which
contains the name of the authoritative master name server for the zone, 
the email address of someone responsible for management of the name server,
The parameters of the SOA record also specify a list of timing
and expiration parameters (serial number, slave refresh period, slave retry time, slave
expiration time, and the maximum time to cache the record). 
If we modify the zone file, we should change the serial number (the highlighted 
number in the SOA entry), so the change can be synchronized to the 
slave nameservers. 

In the zone file, domain names that end with a full stop character (i.e., the dot),
are fully qualified while those that do not end with a full stop are
relative to the current origin. 
For example, in the above example, \texttt{ns1.example.com.} is a full name,
while \texttt{www} example refers to \texttt{www.example.com}.



% *******************************************
% SECTION
% *******************************************
\section{Task 1: Local DNS Server and Public DNS Resolvers} 

Set up the local DNS server for all except AS-155.
So students can configure this one.
Set up the root hint.



\begin{lstlisting}
// In /etc/bind/named.conf.default-zones
zone "." {
	type hint;
	file "/usr/share/dns/root.hints";
};


# more /usr/share/dns/root.hints
.      NS   ns1.
.      NS   ns2.
ns1.   A    10.150.0.72
ns2.   A    10.160.0.72
\end{lstlisting}
 


% *******************************************
% SECTION
% *******************************************
\section{Task 2: Root and TLD Servers} 


% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The Root Servers} 

Although there are multiple root servers, they do not synchronize with
each other; instead, they synchronize with a root zone file. 

In this lab, we will emulate this process: if we modify one root zone
file, we will modify the other accordingly. 

\begin{lstlisting}
//  /etc/bind/named.conf.zones
zone "." { 
    type master; 
    allow-update { any; }; 
    file "/etc/bind/zones/root"; 
};
\end{lstlisting}
 

\begin{lstlisting}
$TTL 300
$ORIGIN .
@ SOA ns1. admin. 2159658311 900 900 1800 60
@      NS   ns1.
@      NS   ns2.
ns1.   A    10.150.0.72
ns2.   A    10.160.0.72
\end{lstlisting}
 


\begin{lstlisting}
$ dig @a.root-servers.net www.example.com
\end{lstlisting}
 



% -------------------------------------------
% SUBSECTION
% -------------------------------------------
\subsection{The TLD Servers} 


We have two nameservers for the \texttt{com.} zone. One is configured as 
the master, and the other as the slave. We only need to modify the zone 
file on the master, as the slave will automatically synchronize its 
zone data with the master. 

\begin{lstlisting}
// For master
zone "com." { type master; allow-transfer { any; }; ...};

// For slave
zone "com." { type slave; masters { 10.151.0.72; }; ... };
\end{lstlisting}
 


% *******************************************
% SECTION
% *******************************************
\section{Task 3: Domain Nameservers} 




% *******************************************
% SECTION
% *******************************************
\section{Task 4: Reverse DNS Lookup} 




% *******************************************
% SECTION
% *******************************************
\section{Task 5: IP Anycast}







% *******************************************
% SECTION
% *******************************************
%\section{Task 6: Using DNS for Load Balancing} 



% *******************************************
% SECTION
% ******************************************* 
\section{Submission}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{\commonfolder/submission}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



% *******************************************
% SECTION
% *******************************************
\section*{Acknowledgment} 

This lab was developed with the help of Honghao Zeng, 
a graduate student in the Department of Electrical Engineering 
and Computer Science at Syracuse University. 
The SEED project was funded in part 
by the grants from the US National Science Foundation
and Syracuse University.

\end{document}



